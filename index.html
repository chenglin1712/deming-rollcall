<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å®¿èˆé»åç³»çµ±</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>å®¿èˆé»åç³»çµ±</h1>
        <p id="welcome-message">è¼‰å…¥ä¸­...</p>
        <button id="logout-btn" class="btn secondary">ç™»å‡º</button>
      </header>

      <main>
        <section class="card">
          <h2>é¸æ“‡é»åç¾¤çµ„</h2>
          <div class="group-selection" id="group-container">
            <p>æ­£åœ¨è¼‰å…¥ç¾¤çµ„...</p>
          </div>
        </section>

        <section class="action-buttons">
          <button
            id="historyBtn"
            class="btn primary"
            onclick="location.href='history.html'"
          >
            æŸ¥çœ‹æ­·å²ç´€éŒ„
          </button>
          <button
            id="addStudentBtn"
            class="btn secondary"
            onclick="location.href='add_student.html'"
          >
            æ–°å¢å­¸ç”Ÿ
          </button>
          <button
            id="studentListBtn"
            class="btn secondary"
            onclick="location.href='student_list.html'"
          >
            å­¸ç”Ÿæ¸…å–®
          </button>
        </section>
      </main>

      <footer>
        <p>Â© 2025 å®¿èˆé»åç³»çµ±</p>
      </footer>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // **ğŸ” æª¢æŸ¥ç™»å…¥ç‹€æ…‹**
        fetch("/api/check-login")
          .then((response) => response.json())
          .then((data) => {
            if (!data.loggedIn) {
              console.log("ğŸš« æœªç™»å…¥ï¼Œè·³è½‰è‡³ login.html");
              window.location.href = "login.html";
              return;
            }
            document.getElementById(
              "welcome-message"
            ).textContent = `ğŸ‘¤ æ­¡è¿ï¼Œ${data.user.display_name}`;

            // **âš ï¸ æª¢æŸ¥æ¬Šé™ï¼šé™åˆ¶ deming å¸³è™Ÿä½¿ç”¨æŒ‰éˆ•**
            if (data.user.username === "deming") {
              const restrictedButtons = document.querySelectorAll(
                "#historyBtn, #addStudentBtn, #studentListBtn"
              );
              restrictedButtons.forEach((btn) => {
                btn.addEventListener("click", (event) => {
                  event.preventDefault(); // é˜»æ­¢æŒ‰éˆ•é»æ“Šè¡Œç‚º
                  alert("ğŸ™…æ¬Šé™ä¸è¶³ï¼Œè«‹æ´½ç³»çµ±ç®¡ç†è€…");
                });
                btn.style.opacity = "0.5"; // è®“æŒ‰éˆ•è®Šæ·¡ï¼Œæç¤ºç„¡æ³•ä½¿ç”¨
                btn.style.cursor = "not-allowed";
              });
            }

            // **ğŸ“Œ å–å¾—ç¾¤çµ„åˆ—è¡¨**
            fetch("/api/groups")
              .then((response) => response.json())
              .then((groups) => {
                const groupContainer =
                  document.getElementById("group-container");
                groupContainer.innerHTML = ""; // æ¸…ç©ºèˆŠå…§å®¹
                if (groups.length === 0) {
                  groupContainer.innerHTML = "<p>âš ï¸ ç›®å‰æ²’æœ‰å¯ç”¨çš„ç¾¤çµ„ã€‚</p>";
                  return;
                }
                groups.forEach((group) => {
                  let groupCard = document.createElement("div");
                  groupCard.className = "group-card";
                  groupCard.onclick = () =>
                    (location.href = `attendance.html?group=${encodeURIComponent(
                      group
                    )}`);
                  groupCard.innerHTML = `<h3>${group}</h3><p>é»æ“Šé€²è¡Œé»å</p>`;
                  groupContainer.appendChild(groupCard);
                });
              })
              .catch((error) => {
                console.error("âŒ è¼‰å…¥ç¾¤çµ„å¤±æ•—:", error);
                document.getElementById("group-container").innerHTML =
                  "<p>âš ï¸ ç„¡æ³•è¼‰å…¥ç¾¤çµ„ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚</p>";
              });
          })
          .catch((error) => {
            console.error("âŒ ç„¡æ³•ç¢ºèªç™»å…¥ç‹€æ…‹:", error);
            window.location.href = "login.html";
          });

        // **ğŸ”“ ä¿®æ­£å¾Œçš„ç™»å‡ºåŠŸèƒ½**
        document
          .getElementById("logout-btn")
          .addEventListener("click", function () {
            fetch("/api/logout", { method: "POST", credentials: "include" })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  console.log("âœ… ç™»å‡ºæˆåŠŸï¼Œè·³è½‰è‡³ login.html");
                  sessionStorage.removeItem("user"); // æ¸…é™¤ sessionStorage
                  window.location.href = "login.html"; // è·³è½‰å›ç™»å…¥é 
                } else {
                  console.error("âŒ ç™»å‡ºå¤±æ•—:", data.message);
                  alert("ç™»å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦ï¼");
                }
              })
              .catch((error) => {
                console.error("âŒ ä¼ºæœå™¨éŒ¯èª¤ï¼Œç„¡æ³•ç™»å‡º:", error);
                alert("ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦ï¼");
              });
          });
      });
    </script>
  </body>
</html>
